---
import MainLayout from '@layouts/MainLayout.astro'
import DocsSidebar from '@components/DocsSidebar.svelte'
import { createSection } from '@lib/docs/section'
import { fsPathToRoute } from '@lib/docs/paths'
import { getPrevNext } from '@lib/docs/routing'
import PageBtn from '@components/PageBtn.astro'
import Breadcrumb from '@components/Breadcrumb.svelte'
import DocsToc from '@components/DocsToc.svelte'
import Footer from '@components/Footer.astro'

export async function getStaticPaths() {
  // Generate a path for every MD/MDX content file
  const mods = import.meta.glob('/src/content/**/*.{md,mdx}', { eager: true })
  const paths: Array<{ params: { section: string; page: string } }> = []
  for (const fs of Object.keys(mods)) {
    const route = fsPathToRoute(fs) // e.g. /basics/introduction/overview
    const parts = route.split('/').filter(Boolean)
    const section = parts[0]
    const page = parts.slice(1).join('/') // catch-all as a single string
    paths.push({ params: { section, page } })
  }
  return paths
}

const section = String(Astro.params.section || '')
const pageParam = (Astro.params as any).page
const segment = Array.isArray(pageParam) ? pageParam.join('/') : pageParam || ''

const sectionApi = createSection(section)
const { nav } = sectionApi.nav()

// If segment points to a group (folder) without an index doc,
// redirect to the group's first item as defined by _toc.ts
if (segment) {
  const parts = String(segment).split('/').filter(Boolean)
  if (parts.length === 1) {
    // Guard: if segment resolves to a doc, do NOT redirect
    const tryResolve = sectionApi.resolver()
    const maybeMod = tryResolve(segment)
    if (!maybeMod) {
      const grp = nav.find((g) => g.dir === parts[0]) as any
      const firstUrl = grp?.items?.[0]?.url // only redirect for real groups with items
      const current = `/${section}` + (segment ? `/${segment}` : '')
      if (firstUrl && firstUrl.replace(/\/$/, '') !== current.replace(/\/$/, '')) {
        return Astro.redirect(firstUrl)
      }
    }
  }
}

const currentPath = `/${section}` + (segment ? `/${segment}` : '')

// Resolve the module via the shared section resolver to avoid duplication
const resolve = sectionApi.resolver()
const mod = resolve(segment) as any
const Page = mod?.default
const { prev, next } = getPrevNext(nav, currentPath)
---

<MainLayout>
  <div class='flex gap-6 items-start'>
    <!-- Left Sidebar - Table of Contents -->
    <aside
      class='sticky self-start overflow-y-auto w-64 shrink-0 border-r border-sd-border [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden'
      style='top: 4rem; height: calc(100vh - 4rem);'
    >
      <div class='p-4'>
        <DocsSidebar
          nav={nav}
          heading=''
          currentPath={currentPath}
          client:load
        />
      </div>
    </aside>

    <!-- Central section - Main Content -->
    <article class='flex-1 min-w-0 pb-12'>
      <div class='py-4'>
        <Breadcrumb
          path={currentPath}
          nav={nav}
        />
      </div>
      <div
        id='content'
        class='prose'
      >
        {
          Page ? (
            <Page />
          ) : (
            <p>⚠️ Unable to resolve content for {currentPath}</p>
          )
        }
      </div>
      <div class='mt-8 flex items-center justify-between'>
        {
          prev ? (
            <PageBtn
              href={prev.url}
              label={prev.title}
               direction='prev'
            />
          ) : (
            <span />
          )
        }
        {
          next ? (
            <PageBtn
              href={next.url}
              label={next.title}
               direction='next'
            />
          ) : (
            <span />
          )
        }
      </div>

      <Footer
        left='Just Go!'
        right='Happy coding!'
      />
    </article>

    <!-- Right Sidebar - On This Page -->
    <aside
      class='hidden xl:block sticky self-start overflow-y-auto w-64 shrink-0 border-l border-sd-border [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden'
      style='top: 4rem; height: calc(100vh - 4rem);'
    >
      <div class='p-4'>
        <DocsToc client:load />
      </div>
    </aside>
  </div>
</MainLayout>
