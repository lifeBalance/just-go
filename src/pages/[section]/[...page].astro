---
import MainLayout from '@layouts/MainLayout.astro'
import DocsSidebar from '@components/DocsSidebar.svelte'
import { createSection } from '@lib/docs/section'
import { listSectionPageParams } from '@lib/docs/section'
import { getPrevNext, resolveOrNext } from '@lib/docs/routing'
import PageBtn from '@components/PageBtn.astro'
import Breadcrumb from '@components/Breadcrumb.svelte'
import DocsToc from '@components/DocsToc.svelte'
import Footer from '@components/Footer.astro'

export async function getStaticPaths() {
  return listSectionPageParams().map(({ section, page }) => ({
    params: { section, page },
  }))
}

const section = String(Astro.params.section || '')
const pageParam = (Astro.params as any).page
const segment = Array.isArray(pageParam) ? pageParam.join('/') : pageParam || ''

const sectionApi = createSection(section)
const result = resolveOrNext(sectionApi, segment)

if (result.kind === 'redirect') {
  return Astro.redirect(result.url)
}

const nav = result.nav
const currentSegment = result.kind === 'ok' ? result.segment : segment
const currentPath = `/${section}` + (currentSegment ? `/${currentSegment}` : '')

const resolve = sectionApi.resolver()
const mod = resolve(currentSegment) as any
const Page = mod?.default
const { prev, next } = getPrevNext(nav, currentPath)
---

<MainLayout>
  <div class='flex gap-6 items-start'>
    <!-- Left Sidebar - Table of Contents -->
    <aside
      class='sticky self-start overflow-y-auto w-64 shrink-0 border-r border-sd-border [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden'
      style='top: 4rem; height: calc(100vh - 4rem);'
    >
      <div class='p-4'>
        <DocsSidebar
          nav={nav}
          heading=''
          currentPath={currentPath}
          client:load
        />
      </div>
    </aside>

    <!-- Central section - Main Content -->
    <article class='flex-1 min-w-0 pb-12'>
      <div class='py-4'>
        <Breadcrumb
          path={currentPath}
          nav={nav}
        />
      </div>
      <div
        id='content'
        class='prose'
      >
        {
          Page ? (
            <Page />
          ) : (
            <p>⚠️ Unable to resolve content for {currentPath}</p>
          )
        }
      </div>
      <div class='mt-8 flex items-center justify-between'>
        {
          prev ? (
            <PageBtn
              href={prev.url}
              label={prev.title}
              direction='prev'
            />
          ) : (
            <span />
          )
        }
        {
          next ? (
            <PageBtn
              href={next.url}
              label={next.title}
              direction='next'
            />
          ) : (
            <span />
          )
        }
      </div>

      <Footer
        left='Just Go!'
        right='Happy coding!'
      />
    </article>

    <!-- Right Sidebar - On This Page -->
    <aside
      class='hidden xl:block sticky self-start overflow-y-auto w-64 shrink-0 border-l border-sd-border [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden'
      style='top: 4rem; height: calc(100vh - 4rem);'
    >
      <div class='p-4'>
        <DocsToc client:load />
      </div>
    </aside>
  </div>
</MainLayout>
