---
import { cva } from 'class-variance-authority'
import { Icon } from 'astro-icon/components'

/**
 * Admonition component
 * - Variants: note | tip | warning | error
 * - Props:
 *   - variant?: 'note' | 'tip' | 'warning' | 'error' (default: 'note')
 *   - title?: string (override default label for the variant)
 *   - icon?: string (Iconify name, e.g., 'mdi:lightbulb-on-outline')
 *   - showIcon?: boolean (default: true)
 *   - class?: string (additional classes)
 */

const props = Astro.props as {
  variant?: 'note' | 'tip' | 'warning' | 'error'
  /** Legacy alias used in some docs */
  type?: 'note' | 'tip' | 'warning' | 'error' | 'info' | 'important'
  title?: string
  /** Custom icon name (Iconify), e.g., "mdi:lightbulb-on-outline" */
  icon?: string
  /** Legacy alias for icon name */
  name?: string
  showIcon?: boolean
  class?: string
}

const typeToVariant: Record<string, 'note' | 'tip' | 'warning' | 'error'> = {
  note: 'note',
  tip: 'tip',
  warning: 'warning',
  error: 'error',
  info: 'note',
  important: 'warning',
}

const variant = props.variant ?? (props.type ? typeToVariant[props.type] ?? 'note' : 'note')
const showIcon = props.showIcon ?? true

const wrapper = cva('admonition my-4 rounded-md border p-4 text-sm', {
  variants: {
    variant: {
      note: 'admonition--note',
      tip: 'admonition--tip',
      warning: 'admonition--warning',
      error: 'admonition--error',
    },
  },
  defaultVariants: { variant: 'note' },
})

const titleMap: Record<'note' | 'tip' | 'warning' | 'error', string> = {
  note: 'Note',
  tip: 'Tip',
  warning: 'Warning',
  error: 'Error',
}

const iconMap: Record<'note' | 'tip' | 'warning' | 'error', string> = {
  note: 'mdi:information-outline',
  tip: 'mdi:lightbulb-on-outline',
  warning: 'mdi:alert-circle-outline',
  error: 'mdi:alert-octagon-outline',
}

const label = props.title ?? titleMap[variant]
const requestedIcon = props.icon ?? props.name
const iconName = requestedIcon ?? iconMap[variant]
const classes = [wrapper({ variant }), props.class].filter(Boolean).join(' ')
---

<div class={classes} role="note" aria-label={label}>
  <div class="flex items-center gap-3">
    {
      showIcon && (
        <Icon
          name={iconName}
          width="20"
          height="20"
          class="admonition__icon mt-0.5 shrink-0"
          aria-hidden="true"
        />
      )
    }
    <div class="admonition__title font-semibold">{label}</div>
  </div>
  <div class="min-w-0">
    <div class="prose :where(p):my-0">
      <slot />
    </div>
  </div>
</div>

<style>
.admonition {
  /* derive visuals from the variant accent */
  border-color: oklch(from var(--_accent) l c h / 0.55);
  background-color: oklch(from var(--_accent) l c h / 0.12);
}

.admonition__title,
.admonition__icon {
  color: var(--_accent);
}

/* wire variant classes to theme tokens */
.admonition--note { --_accent: var(--color-admonition-note); }
.admonition--tip { --_accent: var(--color-admonition-tip); }
.admonition--warning { --_accent: var(--color-admonition-warning); }
.admonition--error { --_accent: var(--color-admonition-error); }

/* dark theme tweaks */
[data-theme='dark'] .admonition {
  background-color: oklch(from var(--_accent) l c h / 0.18);
  border-color: oklch(from var(--_accent) l c h / 0.5);
}

[data-theme='dark'] .admonition__title,
[data-theme='dark'] .admonition__icon {
  color: oklch(from var(--_accent) l c h / 0.9);
}
</style>
