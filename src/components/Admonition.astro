---
import { cva } from 'class-variance-authority'
import { Icon } from 'astro-icon/components'

/**
 * Admonition component
 * - Variants: note | tip | warning | error
 * - Props:
 *   - variant?: 'note' | 'tip' | 'warning' | 'error' (default: 'note')
 *   - title?: string (override default label for the variant)
 *   - icon?: string (Iconify name, e.g., 'mdi:lightbulb-on-outline')
 *   - showIcon?: boolean (default: true)
 *   - class?: string (additional classes)
 */

const props = Astro.props as {
  variant?: 'note' | 'tip' | 'warning' | 'error'
  /** Legacy alias used in some docs */
  type?: 'note' | 'tip' | 'warning' | 'error' | 'info' | 'important'
  title?: string
  /** Custom icon name (Iconify), e.g., "mdi:lightbulb-on-outline" */
  icon?: string
  /** Legacy alias for icon name */
  name?: string
  showIcon?: boolean
  class?: string
}

const typeToVariant: Record<string, 'note' | 'tip' | 'warning' | 'error'> = {
  note: 'note',
  tip: 'tip',
  warning: 'warning',
  error: 'error',
  info: 'note',
  important: 'warning',
}

const variant =
  props.variant ?? (props.type ? (typeToVariant[props.type] ?? 'note') : 'note')
const showIcon = props.showIcon ?? true

// Utility functions to generate color classes
function buildOklchColor(variantName: string, alpha: number): string {
  const cssVarName = `--color-admonition-${variantName}`
  return `oklch(from_var(${cssVarName})_l_c_h_/_${alpha})`
}

function buildBackgroundClass(variantName: string): string {
  const colorValue = buildOklchColor(variantName, 0.12)
  return `bg-[color:${colorValue}]`
}

function buildBorderClass(variantName: string): string {
  const colorValue = buildOklchColor(variantName, 0.55)
  return `border-[color:${colorValue}]`
}

function buildTextClass(variantName: string): string {
  const cssVarName = `--color-admonition-${variantName}`
  return `text-[color:var(${cssVarName})]`
}

const wrapper = cva('my-4 rounded-md border p-4 text-sm', {
  variants: {
    variant: {
      note: `${buildBorderClass('note')} ${buildBackgroundClass('note')}`,
      tip: `${buildBorderClass('tip')} ${buildBackgroundClass('tip')}`,
      warning: `${buildBorderClass('warning')} ${buildBackgroundClass('warning')}`,
      error: `${buildBorderClass('error')} ${buildBackgroundClass('error')}`,
    },
  },
  defaultVariants: { variant: 'note' },
})

const iconClass = cva('mt-0.5 shrink-0', {
  variants: {
    variant: {
      note: 'text-[color:var(--color-admonition-note)]',
      tip: 'text-[color:var(--color-admonition-tip)]',
      warning: 'text-[color:var(--color-admonition-warning)]',
      error: 'text-[color:var(--color-admonition-error)]',
    },
  },
  defaultVariants: { variant: 'note' },
})

const titleClass = cva('font-semibold', {
  variants: {
    variant: {
      note: 'text-[color:var(--color-admonition-note)]',
      tip: 'text-[color:var(--color-admonition-tip)]',
      warning: 'text-[color:var(--color-admonition-warning)]',
      error: 'text-[color:var(--color-admonition-error)]',
    },
  },
  defaultVariants: { variant: 'note' },
})

const titleMap: Record<'note' | 'tip' | 'warning' | 'error', string> = {
  note: 'Note',
  tip: 'Tip',
  warning: 'Warning',
  error: 'Error',
}

const iconMap: Record<'note' | 'tip' | 'warning' | 'error', string> = {
  note: 'mdi:information-outline',
  tip: 'mdi:lightbulb-on-outline',
  warning: 'mdi:alert-circle-outline',
  error: 'mdi:alert-octagon-outline',
}

const label = props.title ?? titleMap[variant]
const requestedIcon = props.icon ?? props.name
const iconName = requestedIcon ?? iconMap[variant]
const classes = [wrapper({ variant }), props.class].filter(Boolean).join(' ')
---

<div class={classes} role="note" aria-label={label}>
  <div class="flex items-center gap-3">
    {
      showIcon && (
        <Icon
          name={iconName}
          width="20"
          height="20"
          class={iconClass({ variant })}
          aria-hidden="true"
        />
      )
    }
    <div class={titleClass({ variant })}>{label}</div>
  </div>
  <div class="min-w-0">
    <div class="prose :where(p):my-0">
      <slot />
    </div>
  </div>
</div>
