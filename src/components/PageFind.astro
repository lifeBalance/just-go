---
import { Icon } from 'astro-icon/components'
---

<button
  id="pf-btn"
  class="inline-flex items-center justify-between gap-2 text-(--sd-muted) bg-(--sd-bg) px-2 py-1 border border-(--sd-border) shadow-[4px_4px_0_var(--sd-border)] rounded font-light transition-all duration-300 cursor-pointer hover:no-underline hover:bg-(--sd-hover) hover:text-(--sd-muted) hover:shadow-[2px_2px_0_var(--sd-muted)] active:text-(--sd-fg) active:shadow-none active:border-(--sd-muted)"
>
  <Icon name="mdi:magnify" />
  <code class="text-xs"><span id="os">Ctrl</span>+k</code>
</button>

<div
  id="search-container"
  aria-hidden="true"
  class="fixed top-16 left-0 z-9999 flex flex-col items-center p-8 bg-(--sd-overlay) min-h-[calc(100vh-4rem)] max-h-[calc(100vh-4rem)] min-w-screen opacity-0 transition-opacity duration-300 overflow-y-auto aria-[hidden=false]:opacity-100 aria-[hidden=false]:pointer-events-auto aria-hidden:opacity-0 aria-hidden:pointer-events-none"
>
  <div id="search" class="w-full max-w-[800px]"></div>
</div>

<script>
  declare global {
    interface Window {
      PagefindUI?: any
    }
  }

  document.addEventListener('astro:page-load', () => {
    const btn = document.getElementById('pf-btn')
    const os = document.getElementById('os')
    const searchContainer = document.getElementById('search-container')
    const search = document.getElementById('search')
    const body = document.body
    const baseAttr = body?.dataset.pagefindBase || import.meta.env.BASE_URL || '/'
    const bundleAttr = body?.dataset.pagefindBundle
    if (!bundleAttr) {
      console.warn('Pagefind bundle not provided on body element; search disabled.')
      return
    }
    const normalizedBase = baseAttr.endsWith('/') ? baseAttr : baseAttr + '/'
    const bundleName = bundleAttr.replace(/\/$/, '')
    const branchId = bundleName.replace(/^pagefind-/, '')

    function normalizeUrl(url?: string) {
      if (!url) return url
      if (/^(https?:)?\/\//i.test(url)) return url

      const cleaned = url.replace(/^\//, '')
      return `${normalizedBase}${cleaned}`
    }

    const bundlePath = normalizedBase + (bundleName.endsWith('/') ? bundleName : bundleName + '/')

    console.log('Search element:', search)
    console.log('PagefindUI available:', !!window.PagefindUI)

    function processResult(result: any) {
      if (!result) return result
      const url = normalizeUrl(result?.url)
      const anchors = Array.isArray(result?.anchors)
        ? result.anchors.map((anchor: any) => ({ ...anchor, url: normalizeUrl(anchor?.url || result?.url) }))
        : result?.anchors

      return {
        ...result,
        url,
        anchors,
      }
    }

    function processTerm(term: string) {
      return term
    }

    // Wait for PagefindUI to be available
    function initializePagefind() {
      if (!window.PagefindUI) {
        console.warn('PagefindUI not yet loaded, retrying...')
        setTimeout(initializePagefind, 100)
        return
      }

      if (search && !search.dataset.pagefindInitialized) {
        try {
          new window.PagefindUI({
            element: '#search',
            showSubResults: true,
            bundlePath,
            process_result: processResult,
            process_term: processTerm,
          })
          search.dataset.pagefindInitialized = 'true'
          console.log('Pagefind initialized successfully')
        } catch (error) {
          console.error('Failed to initialize Pagefind:', error)
        }
      }
    }

    initializePagefind()

    function toggleSearch() {
      if (!searchContainer) return
      
      const isSearchVisible = searchContainer.getAttribute('aria-hidden') === 'false'
      searchContainer.setAttribute('aria-hidden', isSearchVisible ? 'true' : 'false')
      
      console.log('Toggle search, now visible:', !isSearchVisible)
      
      if (!isSearchVisible && search) {
        setTimeout(() => {
          const input = search.querySelector('input')
          if (input) {
            input.focus()
            console.log('Input focused')
          } else {
            console.warn('Input element not found')
          }
        }, 100)
      }
    }

    const isMac = window.navigator.userAgent.includes('Mac')
    if (os) os.textContent = isMac ? 'Cmd' : 'Ctrl'

    btn?.addEventListener('click', () => {
      console.log('Button clicked')
      toggleSearch()
    })
    
    searchContainer?.addEventListener('click', (event) => {
      if (event.target === searchContainer) {
        toggleSearch()
      }
    })

    document.addEventListener('keydown', (event) => {
      const isShortcutPressed = isMac
        ? event.metaKey && event.key.toLowerCase() === 'k'
        : event.ctrlKey && event.key.toLowerCase() === 'k'

      if (isShortcutPressed) {
        event.preventDefault()
        toggleSearch()
      }
    })
  })
</script>

