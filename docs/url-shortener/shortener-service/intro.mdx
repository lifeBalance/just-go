import Admonition from '@components/Admonition.astro'

# Overview

In the previous **Setup** section, we implemented a **stub** of the shortener service, and wire it up in the **entry point** of the app, using **DI**. If you check the code, we're just returning a **hardcoded shortcode**:

```go
return ShortenResponse{
    ShortCode:   "stub123",
    OriginalURL: req.URL,
}, nil
```

## What the Service Does

This service will be in charge of a couple of flows:

1. When a user submits a `POST` request containing a **long URL** to our app, the service generate a **short-code** for this long URL, and the pair is stored.
2. Whenever our app receives a GET request to `http://<our-domain>/<short-code>`, we can look up the **short-code** in our storage, and send back to the user a redirect to the original URL.

In this section we'll add the code responsible for turning **long URLs** into unique **short codes**.

<Admonition title="Next Section">
  In this section we'll take care of **service setup** and **short-code** generation; in the next section will complete both flows. 
</Admonition>

## Types

In the flows we were just discussing, the service needs to deal with HTTP handlers deal with request and responses. Let's add types for them:

```go
type ShortenRequest struct {
	URL string
}

type ShortenResponse struct {
	ShortCode   string
	OriginalURL string
}
```

The **generator** and the **store** are essential parts of our service:

```go
type Shortener struct {
	generator CodeGenerator
	store     nil // TODO: Next section
}

type CodeGenerator interface {
	Generate(ctx context.Context) (string, error)
}
```

Notice that we're defining the `generator` as an **interface**, this will allow for **DI**, as we'll see in the next section.

## Generating Short Codes

At the `shortener` service, we need a function for generating short codes:

```go
func (g *RandomCodeGenerator) Generate(_ context.Context) (string, error) {
	g.mu.Lock()
	defer g.mu.Unlock()
	code := make([]rune, g.length)
	for i := range code {
		code[i] = g.alphabet[g.rnd.Intn(len(g.alphabet))]
	}
	return string(code), nil
}
```

`Generate` is a `RandomCodeGenerator` method, which produces a random short code in a **thread-safe way**:

- Locks the generator (`g.mu.Lock()`) so concurrent goroutines donâ€™t race the shared `rnd` field.
- Prepares a rune slice of the configured length (`g.length`).
- Fills each position with a **random rune** from the allowed **alphabet**.
- Returns the slice as a string.
