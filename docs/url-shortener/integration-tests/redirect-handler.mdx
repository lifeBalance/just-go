import Admonition from '@components/Admonition.astro'

# Redirect Handler Test

The HTTP hander for the `GET /{shortCode}` endpoint works as follows:

1. Extract the **short code** from the URL.
2. Look up the code via the storage-backed shortener service
3. *ncrements the hit counter.
4. Responds with an HTTP redirect (`302 Found`).

The `TestRedirectHandlerSuccess` integration test proves that flow end to end.

- Seeds the in-memory store with a known entry (`stub123 â†’ https://example.com`).
- Calls the real router with a `GET /stub123` request.
- Asserts the handler responds with status `302` and sets the `Location`
  header to the original URL.
- Confirms the store reflects the updated `HitCount` after the redirect.

Here is the test in `/internal/api/router_test.go`:

```go
func TestRedirectHandlerSuccess(t *testing.T) {
    store := storage.NewInMemoryStore()
    shortener := shortenerpkg.NewShortener(stubGenerator{code: "stub123"}, store)
    router := NewRouter(shortener)

    _ = store.Save(context.Background(), storage.Entry{
        ShortCode:   "stub123",
        OriginalURL: "https://example.com",
    })

    req := httptest.NewRequest(http.MethodGet, "/stub123", nil)
    rec := httptest.NewRecorder()

    router.ServeHTTP(rec, req)

    if rec.Code != http.StatusFound {
        t.Fatalf("expected status 302, got %d", rec.Code)
    }

    loc := rec.Header().Get("Location")
    if loc != "https://example.com" {
        t.Fatalf("expected Location header to be https://example.com, got %s", loc)
    }

    entry, err := store.Find(context.Background(), "stub123")
    if err != nil {
        t.Fatalf("expected entry to exist, got error: %v", err)
    }
    if entry.HitCount != 1 {
        t.Fatalf("expected HitCount 1, got %d", entry.HitCount)
    }
}
```

<Admonition type="Run Tests">
  Run `go test ./internal/api` to execute both the shortening and redirect
  integration tests.
</Admonition>
